#include <WiFi.h>
#include <BlynkSimpleEsp32.h>

// ---------------- Config ----------------
char auth[] = "9lK0S30gQJsN-Ql_bj8YvpivdFkiQfjp";   // Blynk Token
char ssid[] = "00";                                // WiFi SSID
char pass[] = "123456789";                         // WiFi Password

char blynk_server[] = "iotservices.thddns.net";    // Blynk Server (Local)
int blynk_port = 5534;                             // Server Port

#define flowPin 4   // à¸‚à¸²à¸‚à¸­à¸‡ Flow Sensor à¸•à¹ˆà¸­à¸—à¸µà¹ˆ GPIO4

volatile int pulseCount = 0;
float flowRate = 0;
float totalLiters = 0;
float calibrationFactor = 4.5; 

unsigned long oldTime = 0;

float waterFee = 7.0;    // à¸„à¹ˆà¸²à¸™à¹‰à¸³à¸•à¹ˆà¸­à¸¥à¸´à¸•à¸£ (à¸šà¸²à¸—)
float roomFee  = 2500.0;  // à¸„à¹ˆà¸²à¹€à¸Šà¹ˆà¸²à¸«à¹‰à¸­à¸‡ (à¸šà¸²à¸—)

// ---------- Interrupt ----------
void IRAM_ATTR pulseCounter() {
  pulseCount++;
}

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("ðŸš€ ESP32 Started");
  
  // ---------------- WiFi ----------------
  WiFi.begin(ssid, pass);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nâœ… WiFi Connected");
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());

  // ---------------- Blynk ----------------
  Blynk.config(auth, blynk_server, blynk_port);
  if (Blynk.connect()) {
    Serial.println("âœ… Connected to Blynk Server");
  } else {
    Serial.println("âš ï¸ Blynk not connected, will keep trying in loop...");
  }

  pinMode(flowPin, INPUT_PULLUP);
  attachInterrupt(flowPin, pulseCounter, FALLING);

  oldTime = millis();
}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    Blynk.run();
    if (!Blynk.connected()) {
      Blynk.connect();
    }
  }

  // à¸­à¸±à¸›à¹€à¸”à¸•à¸„à¹ˆà¸²à¸—à¸¸à¸ 1 à¸§à¸´à¸™à¸²à¸—à¸µ
  if ((millis() - oldTime) > 1000) {
    detachInterrupt(flowPin);

    flowRate = ((1000.0 / (millis() - oldTime)) * pulseCount) / calibrationFactor;
    oldTime = millis();
    pulseCount = 0;

    float flowMilliLiters = (flowRate / 60) * 1000;
    totalLiters += flowMilliLiters / 1000.0;

    float waterBill = totalLiters * waterFee;
    float totalBill = roomFee + waterBill;

    // -------- Debug --------
    Serial.print("ðŸ’§ Flow Rate: ");
    Serial.print(flowRate);
    Serial.print(" L/min | Total: ");
    Serial.print(totalLiters);
    Serial.print(" L | Water Fee: ");
    Serial.print(waterBill);
    Serial.print(" à¸¿ | Total Bill: ");
    Serial.print(totalBill);
    Serial.println(" à¸¿");

    // -------- à¸ªà¹ˆà¸‡à¸‚à¸¶à¹‰à¸™ Blynk --------
    Blynk.virtualWrite(V1, flowRate);
    Blynk.virtualWrite(V2, totalLiters);
    Blynk.virtualWrite(V3, waterBill);
    Blynk.virtualWrite(V4, totalBill);

    attachInterrupt(flowPin, pulseCounter, FALLING);
  }
}
